{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chatbot â€“ Gestion du Courrier</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <style>
    body { background:#f5f7fb; }
    .chat-card { max-width: 900px; margin: 40px auto; }
    .msg { padding: .6rem .9rem; border-radius: .6rem; margin-bottom: .5rem; }
    .msg.user { background:#0d6efd; color:#fff; align-self:flex-end; }
    .msg.bot  { background:#fff; border:1px solid #e7e9ee; }
    .messages { display:flex; flex-direction:column; gap:.3rem; min-height:300px; }
    .matched { font-size: .85rem; color:#6c757d; border-left: 3px solid #e9ecef; padding-left: 8px; }
    .spinner { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card chat-card shadow-sm">
      <div class="card-header bg-primary text-white">
        <strong>Assistant Courrier â€“ SÃ©nat</strong>
      </div>
      <div class="card-body">
        <div id="messages" class="messages"></div>

        <div id="matches" class="mt-3 matched d-none"></div>

        <form id="chat-form" class="mt-3 d-flex gap-2" onsubmit="return sendMessage(event)">
        {% csrf_token %}
        <input id="message" class="form-control" placeholder="Votre question..." />
        <button class="btn btn-primary">Envoyer</button>
        </form>

        <div class="spinner mt-2 text-muted">
          <div class="small">Analyse en coursâ€¦</div>
        </div>
      </div>
    </div>
  </div>

<script>
const $messages = document.getElementById('messages');
const $matches  = document.getElementById('matches');
const $form     = document.getElementById('chat-form');
const $input    = document.getElementById('message');
const $spinner  = document.querySelector('.spinner');

function appendMsg(text, who='bot') {
  const div = document.createElement('div');
  div.className = `msg ${who}`;
  div.textContent = text;
  $messages.appendChild(div);
  $messages.scrollTop = $messages.scrollHeight;
}

async function sendMessage(e){
  e.preventDefault();
  const text = ($input.value || '').trim();
  if(!text) return;

  appendMsg(text, 'user');
  $input.value = '';
  $spinner.style.display = 'block';

  try {
  const res = await fetch("{% url 'senat:chatbot-ask' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
    body: JSON.stringify({ message: text })
  });

  let data;
  try {
    data = await res.json();
  } catch {
    appendMsg("RÃ©ponse non valide du serveur.", 'bot');
    console.error("RÃ©ponse non-JSON:", await res.text());
    return false;
  }

  if (!res.ok) {
    appendMsg(data.error || "Erreur cÃ´tÃ© serveur.", 'bot');
    console.error("HTTP", res.status, data);
    return false;
  }

  if (data.ok) {
    appendMsg(data.answer, 'bot');
    if (Array.isArray(data.matched) && data.matched.length){
      $matches.classList.remove('d-none');
      $matches.innerHTML =
        "<strong>Courriers trouvÃ©s :</strong><br>" +
        data.matched.map(m =>
          `â€¢ [${m.code}] ${m.types} â€” ${m.objet} (${m.service_traitement || 'â€”'}, ${m.mention || 'â€”'})`
        ).join("<br>");
    } else {
      $matches.classList.add('d-none'); $matches.innerHTML = '';
    }
  } else {
    appendMsg(data.error || "DÃ©solÃ©, une erreur est survenue.", 'bot');
    console.error("Payload reÃ§u:", data);
  }
} catch (err) {
  appendMsg("Erreur rÃ©seau/serveur.", 'bot');
  console.error(err);
} finally {
    $spinner.style.display = 'none';
  }
  return false;
}

// Utilitaire pour CSRF (si tu utilises le middleware Django CSRF)
function getCSRFToken(){
  const name = 'csrftoken';
  const cookies = document.cookie.split(';');
  for (let c of cookies){
    c = c.trim();
    if (c.startsWith(name + '=')) return c.substring(name.length + 1);
  }
  return '';
}

// Message d'accueil
appendMsg("Bonjour ðŸ‘‹ Je peux vous aider Ã  consulter les courriers (types, services, mentions, dÃ©laisâ€¦). Posez votre question !");
</script>
</body>
</html>
